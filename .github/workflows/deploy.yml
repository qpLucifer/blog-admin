name: Deploy Blog Admin Frontend

on:
  push:
    branches:
      - master  # æˆ–è€…ä½ ä½¿ç”¨çš„ä¸»åˆ†æ”¯å

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install env-cmd globally
        run: npm install -g env-cmd

      - name: Create production environment file
        run: |
          cat > .env.production << 'EOF'
          # ç”Ÿäº§ç¯å¢ƒç«¯å£
          PORT=3001
          
          # åç«¯ API æœåŠ¡åœ°å€ (ä½¿ç”¨ä½ çš„æœåŠ¡å™¨IP)
          REACT_APP_API_BASE_URL=${{ secrets.PROD_API_BASE_URL }}
          
          # å›¾ç‰‡ç­‰é™æ€èµ„æºçš„åŸºç¡€ URL
          REACT_APP_IMAGE_BASE_URL=${{ secrets.PROD_IMAGE_BASE_URL }}
          
          # WebSocket æœåŠ¡åœ°å€
          REACT_APP_WS_URL=${{ secrets.PROD_WS_URL }}
          
          # ç”Ÿæˆæ—¶é—´æˆ³
          REACT_APP_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      - name: Run type check
        run: npm run type-check

      - name: Run linting
        run: npm run lint

      - name: Build for production
        run: npm run build:prod

      - name: Create deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…ï¼ŒåŒ…å«æ„å»ºæ–‡ä»¶å’Œnginxé…ç½®
          mkdir -p deploy-package
          cp -r build/* deploy-package/
          
          # åˆ›å»ºnginxé…ç½®æ–‡ä»¶
          cat > deploy-package/nginx.conf << 'EOF'
          server {
              listen 80;
              server_name _;
              root /www/wwwroot/blog-admin;
              index index.html;
              
              # å¤„ç†React Routerçš„å‰ç«¯è·¯ç”±
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # ç¼“å­˜é™æ€èµ„æº
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # APIä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
              # location /api/ {
              #     proxy_pass http://127.0.0.1:3000/;
              #     proxy_set_header Host $host;
              #     proxy_set_header X-Real-IP $remote_addr;
              #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              #     proxy_set_header X-Forwarded-Proto $scheme;
              # }
              
              # å®‰å…¨å¤´è®¾ç½®
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
          }
          EOF
          
          # éªŒè¯éƒ¨ç½²åŒ…å†…å®¹
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å†…å®¹:"
          ls -la deploy-package/
          echo "ğŸ“ buildç›®å½•å†…å®¹:"
          ls -la build/
          echo "ğŸ” æ£€æŸ¥index.htmlæ˜¯å¦å­˜åœ¨:"
          if [ -f "deploy-package/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            ls -la deploy-package/index.html
            echo "ğŸ“„ index.html å‰5è¡Œå†…å®¹:"
            head -5 deploy-package/index.html
          else
            echo "âŒ index.html ä¸å­˜åœ¨"
            echo "ğŸ” æ£€æŸ¥buildç›®å½•æ˜¯å¦æœ‰index.html:"
            if [ -f "build/index.html" ]; then
              echo "âœ… build/index.html å­˜åœ¨ï¼Œä½†å¤åˆ¶å¤±è´¥"
              ls -la build/index.html
            else
              echo "âŒ build/index.html ä¹Ÿä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
            fi
            exit 1
          fi

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy-package/*"
          target: "/tmp/blog-admin-deploy"
          strip_components: 1

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ” æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶:"
            ls -la /tmp/blog-admin-deploy/
            echo "ğŸ“„ æ£€æŸ¥ä¸´æ—¶ç›®å½•ä¸­çš„index.html:"
            if [ -f "/tmp/blog-admin-deploy/index.html" ]; then
              echo "âœ… ä¸´æ—¶ç›®å½•ä¸­æœ‰index.html"
              ls -la /tmp/blog-admin-deploy/index.html
              echo "ğŸ“„ index.html å‰5è¡Œå†…å®¹:"
              head -5 /tmp/blog-admin-deploy/index.html
            else
              echo "âŒ ä¸´æ—¶ç›®å½•ä¸­æ²¡æœ‰index.html"
              echo "ğŸ“ ä¸´æ—¶ç›®å½•å®Œæ•´å†…å®¹:"
              ls -la /tmp/blog-admin-deploy/
              exit 1
            fi
            
            # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆä½¿ç”¨ä¸BlogBackendç›¸åŒçš„æ¨¡å¼ï¼‰
            sudo mkdir -p ${{ secrets.TARGET_DIR }}/blog-admin
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "${{ secrets.TARGET_DIR }}/blog-admin" ] && [ "$(ls -A ${{ secrets.TARGET_DIR }}/blog-admin)" ]; then
              sudo mv ${{ secrets.TARGET_DIR }}/blog-admin ${{ secrets.TARGET_DIR }}/blog-admin-backup-$(date +%Y%m%d-%H%M%S)
              sudo mkdir -p ${{ secrets.TARGET_DIR }}/blog-admin
            fi
            
            # ç§»åŠ¨æ–°æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
            echo "ğŸ” ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•..."
            sudo mv /tmp/blog-admin-deploy/* ${{ secrets.TARGET_DIR }}/blog-admin/
            
            echo "ğŸ” æ£€æŸ¥ç›®æ ‡ç›®å½•æ–‡ä»¶:"
            ls -la ${{ secrets.TARGET_DIR }}/blog-admin/
            echo "ğŸ“„ æ£€æŸ¥ç›®æ ‡ç›®å½•ä¸­çš„index.html:"
            if [ -f "${{ secrets.TARGET_DIR }}/blog-admin/index.html" ]; then
              echo "âœ… ç›®æ ‡ç›®å½•ä¸­æœ‰index.html"
              ls -la ${{ secrets.TARGET_DIR }}/blog-admin/index.html
            else
              echo "âŒ ç›®æ ‡ç›®å½•ä¸­æ²¡æœ‰index.html"
              exit 1
            fi
            
            # åˆ›å»ºå®å¡”é¢æ¿ç½‘ç«™ç›®å½•
            sudo mkdir -p /www/wwwroot/blog-admin
            
            # æ¸…ç©ºç½‘ç«™ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
            echo "ğŸ” å¤åˆ¶æ–‡ä»¶åˆ°ç½‘ç«™ç›®å½•..."
            sudo rm -rf /www/wwwroot/blog-admin/*
            
            # ä½¿ç”¨æ›´è¯¦ç»†çš„å¤åˆ¶å‘½ä»¤
            echo "ğŸ” æ‰§è¡Œå¤åˆ¶å‘½ä»¤..."
            sudo cp -rv ${{ secrets.TARGET_DIR }}/blog-admin/* /www/wwwroot/blog-admin/
            
            # å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨rsync
            if [ $? -ne 0 ]; then
              echo "âš ï¸ cpå‘½ä»¤å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨rsync..."
              sudo rsync -av ${{ secrets.TARGET_DIR }}/blog-admin/ /www/wwwroot/blog-admin/
            fi
            
            echo "ğŸ” æ£€æŸ¥ç½‘ç«™ç›®å½•æ–‡ä»¶:"
            ls -la /www/wwwroot/blog-admin/
            echo "ğŸ“„ æ£€æŸ¥ç½‘ç«™ç›®å½•ä¸­çš„index.html:"
            if [ -f "/www/wwwroot/blog-admin/index.html" ]; then
              echo "âœ… ç½‘ç«™ç›®å½•ä¸­æœ‰index.html"
              ls -la /www/wwwroot/blog-admin/index.html
            else
              echo "âŒ ç½‘ç«™ç›®å½•ä¸­æ²¡æœ‰index.html"
              echo "ğŸ” æ£€æŸ¥å¤åˆ¶å‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯..."
              echo "ğŸ“ ç›®æ ‡ç›®å½•å†…å®¹:"
              ls -la ${{ secrets.TARGET_DIR }}/blog-admin/
              echo "ğŸ“ ç½‘ç«™ç›®å½•å†…å®¹:"
              ls -la /www/wwwroot/blog-admin/
              echo "ğŸ” å°è¯•æ‰‹åŠ¨å¤åˆ¶å•ä¸ªæ–‡ä»¶..."
              sudo cp ${{ secrets.TARGET_DIR }}/blog-admin/index.html /www/wwwroot/blog-admin/
              if [ -f "/www/wwwroot/blog-admin/index.html" ]; then
                echo "âœ… æ‰‹åŠ¨å¤åˆ¶æˆåŠŸ"
                ls -la /www/wwwroot/blog-admin/index.html
              else
                echo "âŒ æ‰‹åŠ¨å¤åˆ¶ä¹Ÿå¤±è´¥"
                exit 1
              fi
            fi
            
            # è®¾ç½®æƒé™
            sudo chown -R www:www ${{ secrets.TARGET_DIR }}/blog-admin
            sudo chmod -R 755 ${{ secrets.TARGET_DIR }}/blog-admin
            
            # è®¾ç½®å®å¡”é¢æ¿ç›®å½•æƒé™
            sudo chown -R www:www /www/wwwroot/blog-admin
            sudo chmod -R 755 /www/wwwroot/blog-admin
            
            # ç¡®ä¿ç½‘ç«™ç›®å½•æœ‰æ­£ç¡®çš„æƒé™
            sudo chmod 755 /www/wwwroot/blog-admin
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf /tmp/blog-admin-deploy
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
            cd ${{ secrets.TARGET_DIR }} && sudo ls -dt blog-admin-backup-* 2>/dev/null | tail -n +4 | sudo xargs rm -rf
            
            echo "âœ… Blog Admin frontend deployed successfully!"
            echo "ğŸ“¦ Build completed at: $(date)"
            echo "ğŸ“ Deployed to: ${{ secrets.TARGET_DIR }}/blog-admin"
            echo "ğŸŒ Web accessible at: /www/wwwroot/blog-admin"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ” è¯¦ç»†æ£€æŸ¥éƒ¨ç½²çŠ¶æ€:"
            
            # æ£€æŸ¥ç›®æ ‡ç›®å½•
            echo "ğŸ“ ç›®æ ‡ç›®å½• ${{ secrets.TARGET_DIR }}/blog-admin:"
            ls -la ${{ secrets.TARGET_DIR }}/blog-admin/
            
            # æ£€æŸ¥ç½‘ç«™ç›®å½•
            echo "ğŸ“ ç½‘ç«™ç›®å½• /www/wwwroot/blog-admin:"
            ls -la /www/wwwroot/blog-admin/
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éƒ¨ç½²æˆåŠŸ
            if [ -f "/www/wwwroot/blog-admin/index.html" ]; then
              echo "âœ… Frontend files deployed successfully"
              echo "ğŸ“„ index.html å†…å®¹é¢„è§ˆ:"
              head -5 /www/wwwroot/blog-admin/index.html
            else
              echo "âŒ Deployment failed: index.html not found in /www/wwwroot/blog-admin/"
              
              # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
              if [ -f "${{ secrets.TARGET_DIR }}/blog-admin/index.html" ]; then
                echo "âš ï¸ index.html exists in target dir but not in web dir"
                echo "ğŸ“„ Target dir index.html content:"
                head -5 ${{ secrets.TARGET_DIR }}/blog-admin/index.html
              else
                echo "âŒ index.html not found in target dir either"
                echo "ğŸ” æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨:"
                if [ -d "${{ secrets.TARGET_DIR }}/blog-admin" ]; then
                  echo "âœ… ç›®æ ‡ç›®å½•å­˜åœ¨"
                  echo "ğŸ“ ç›®æ ‡ç›®å½•å†…å®¹:"
                  ls -la ${{ secrets.TARGET_DIR }}/blog-admin/
                else
                  echo "âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨"
                fi
              fi
              exit 1
            fi

      - name: Notify deployment status
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Deployment Summary:"
            echo "ğŸ“… Time: $(date)"
            echo "ğŸŒ Project: Blog Admin Frontend"
            echo "ğŸ“‹ Status: ${{ job.status }}"
            echo "ğŸ“ Deployed to: ${{ secrets.TARGET_DIR }}/blog-admin"
            echo "ğŸŒ Web accessible at: /www/wwwroot/blog-admin"
            echo "ğŸ”— Expected URL: http://${{ secrets.SERVER_IP }}/ (é…ç½®åŸŸååä½¿ç”¨åŸŸåè®¿é—®)"
            echo ""
            echo "ğŸ”§ éœ€è¦çš„GitHub Secrets:"
            echo "- SERVER_IP: æœåŠ¡å™¨IPåœ°å€"
            echo "- SSH_USERNAME: SSHç”¨æˆ·å"
            echo "- SSH_PRIVATE_KEY: SSHç§é’¥"
            echo "- TARGET_DIR: ç›®æ ‡éƒ¨ç½²ç›®å½• (å¦‚: /www/wwwroot)"
            echo "- PROD_API_BASE_URL: ç”Ÿäº§ç¯å¢ƒAPIåœ°å€ (å¦‚: http://your-server:3000)"
            echo "- PROD_IMAGE_BASE_URL: ç”Ÿäº§ç¯å¢ƒå›¾ç‰‡åœ°å€ (å¦‚: http://your-server:3000)"
            echo "- PROD_WS_URL: ç”Ÿäº§ç¯å¢ƒWebSocketåœ°å€ (å¦‚: http://your-server:3000)"
